<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>API Endpoint Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #333; }
        .success { background: #1e3a1e; border-color: #4caf50; }
        .error { background: #3a1e1e; border-color: #f44336; }
        .pending { background: #3a3a1e; border-color: #ff9800; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .endpoint { font-weight: bold; color: #4ec9b0; }
        .status { margin-left: 10px; }
    </style>
</head>
<body>
    <h1>Weekly Planner API Endpoint Test</h1>
    <div>
        <button onclick="runTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear</button>
    </div>
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1';
        let token = null;

        async function request(method, endpoint, data = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };

            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }

            if (data && method !== 'GET') {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const text = await response.text();
                let json = null;
                try {
                    json = JSON.parse(text);
                } catch (e) {
                    json = { rawText: text };
                }
                return {
                    status: response.status,
                    ok: response.ok,
                    data: json,
                    endpoint
                };
            } catch (error) {
                return {
                    status: 0,
                    ok: false,
                    error: error.message,
                    endpoint
                };
            }
        }

        function addResult(endpoint, method, result) {
            const div = document.createElement('div');
            div.className = 'test ' + (result.ok ? 'success' : 'error');

            let statusText = result.status === 0 ? 'NETWORK ERROR' : `HTTP ${result.status}`;
            let statusClass = result.ok ? 'success' : 'error';

            div.innerHTML = `
                <div>
                    <span class="endpoint">${method} ${endpoint}</span>
                    <span class="status ${statusClass}">${statusText}</span>
                </div>
                <pre>${JSON.stringify(result.data || result.error, null, 2)}</pre>
            `;

            document.getElementById('results').appendChild(div);
        }

        async function runTests() {
            clearResults();

            // 1. Login first
            addResult('/auth/login', 'POST', { status: 0, ok: false, data: 'Attempting login...' });
            const loginResult = await request('POST', '/auth/login', {
                email: 'test@example.com',
                password: 'password123'
            });

            if (loginResult.ok && loginResult.data) {
                token = loginResult.data.accessToken || loginResult.data.token;
                addResult('/auth/login', 'POST', loginResult);

                if (!token) {
                    addResult('', '', {
                        status: 0,
                        ok: false,
                        error: 'No token received from login'
                    });
                    return;
                }
            } else {
                addResult('/auth/login', 'POST', loginResult);
                addResult('', '', {
                    status: 0,
                    ok: false,
                    error: 'Login failed. Cannot continue tests.'
                });
                return;
            }

            // 2. Test endpoints that might not exist
            const endpointsToTest = [
                { method: 'GET', path: '/plans/current', description: 'Current week plan (may not exist)' },
                { method: 'GET', path: '/plans', description: 'Plans list (fallback for current)' },
                { method: 'GET', path: '/today', description: 'Today endpoint (may not exist)' },
                { method: 'GET', path: '/reviews/current', description: 'Current review (may not exist)' },
                { method: 'GET', path: '/notifications', description: 'Notifications' },
                { method: 'GET', path: '/auth/me', description: 'Current user info' },
            ];

            for (const test of endpointsToTest) {
                const result = await request(test.method, test.path);
                addResult(test.path, test.method, result);

                // If it's the plans list, check if we got data
                if (test.path === '/plans' && result.ok) {
                    const plans = result.data.content || result.data;
                    if (Array.isArray(plans) && plans.length > 0) {
                        // Try to get the first plan's details
                        const planId = plans[0].id;
                        if (planId) {
                            const planResult = await request('GET', `/plans/${planId}`);
                            addResult(`/plans/${planId}`, 'GET', planResult);

                            // Try review endpoint
                            const reviewResult = await request('GET', `/plans/${planId}/review`);
                            addResult(`/plans/${planId}/review`, 'GET', reviewResult);
                        }
                    }
                }
            }

            // 3. Test creating a new plan
            const monday = new Date();
            monday.setDate(monday.getDate() - (monday.getDay() || 7) + 1);
            const weekStartDate = monday.toISOString().split('T')[0];

            const createPlanResult = await request('POST', '/plans', { weekStartDate });
            addResult('/plans', 'POST', createPlanResult);

            if (createPlanResult.ok && createPlanResult.data.id) {
                const planId = createPlanResult.data.id;

                // Test task creation
                const taskDate = weekStartDate;
                const createTaskResult = await request(
                    'POST',
                    `/plans/${planId}/tasks?date=${taskDate}`,
                    {
                        title: 'Test Task',
                        description: 'API Test',
                        priority: 'MEDIUM'
                    }
                );
                addResult(`/plans/${planId}/tasks?date=${taskDate}`, 'POST', createTaskResult);

                if (createTaskResult.ok && createTaskResult.data.id) {
                    const taskId = createTaskResult.data.id;

                    // Test task update
                    const updateResult = await request(
                        'PUT',
                        `/plans/${planId}/tasks/${taskId}`,
                        { status: 'IN_PROGRESS' }
                    );
                    addResult(`/plans/${planId}/tasks/${taskId}`, 'PUT', updateResult);
                }
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>